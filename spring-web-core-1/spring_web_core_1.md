# 스프링 MVC 1편

---

##### 웹서버

- HTTP 기반 동작
- 정적 리소스(html, css, js, 이미지, 영상) 제공 + 기타 부가기능
- nginx, apache

##### 웹 어플리케이션 서버(WAS)

- HTTP 기반 동작
- 웹서버 기능 + 프로그램 코드를 실행하여 로직 수행
    - 동적 html, HTTP API(JSON)
    - 서블릿, JSP, 스프링 MVC
- Tomcat, Jetty, Undertow

##### 웹서버 vs. WAS

- 웹서버는 정적 리소스, WAS는 어플리케이션 로직
- 그러나, 최근에는 경계가 모호
    - 웹서버도 플러그인을 통해 프로그램 실행하는 경우 O
    - WAS도 웹서버의 기능 제공
- 자바는 보통 서블릿 컨테이너 기능을 제공하면 WAS
    - 그러나, 서블릿 없이 자바코드를 실행하는 서버 프레임워크도 존재
- **WAS는 애플리케이션 코드 실행에 특화**

##### 웹 시스템 구성
- WAS, DB 만으로 구성
    - WAS는 정적 리소스와 애플리케이션 로직 모두 제공 가능하므로
    - 단점
        - WAS가 너무 많은 역할 -> 서버 과부하 우려
        - 비싼 애플리케이션 로직(실제 중요한 비즈니스 로직)이 정적 리소스로 인해 수행이 어려울 수 있음
        - WAS 장애시 오류 화면 노출 불가 -> 접근 자체가 안되니까
- 웹서버 - WAS - DB
    - 일반적으로 구성하는 시스템
    - 정적 리소스는 웹서버가 처리
    - 웹서버는 동적인 로직 처리가 필요하면 WAS에 요청 위임
    - WAS는 중요한 애플리케이션 로직 처리 전담
    - 장점
        - 효율적인 리소스 관리
        - 웹서버는 잘 죽지 않음(단순) + WAS는 잘 죽음(복잡)
            - WAS, DB 장애시 웹서버가 오류 화면 제공 가능


##### 서블릿
- urlPatterns의 URL이 호출되면 서블릿 코드 실행
- HTTP 메세지를 처리하기 쉽게 사용할 수 있는 객체
    - 요청 : HttpServletRequest
    - 응답 : HttpServletResponse
    - HTTP 스펙을 편리하게 사용 가능
- HTTP 요청, 응답 흐름
    - HTTP 요청시
        1. WAS는 Request, Response 객체를 새로 만들어 서블릿 객체 호출
        2. 개발자는 Request 객체에서 HTTP 요청 정보를 편리하게 꺼내 사용
        3. Response 객체에 HTTP 응답 정보를 편리하게 입력
        4. WAS는 Response 객체에 담긴 내용으로 HTTP 응답 정보 생성
- 서블릿 컨테이너
    - 서블릿 객체의 생명주기를 관리하는 컨테이너
    - 톰캣과 같이 서블릿을 지원하는 WAS
    - 싱글톤으로 관리
        - 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용
        - 모든 고객 요청이 동일한 서블릿 객체 인스턴스에 접근
            - HTTP Request, Response 객체는 요청마다 새로 생성 -> 요청마다 고객이 다 다르니까!
        - 공유 변수 사용 주의
    - 동시 요청을 위한 멀티 쓰레드 처리 지원
- **멀티 쓰레드**
    - 서블릿 객체는 누가 호출?
        - 쓰레드가 호출
        - 쓰레드는 한 번에 하나의 코드 라인만 수행
    - 처리 방식
        - 요청마다 쓰레드 생성
            - 장점
                - 동시요청 처리 가능
                - 리소스가 허용하는 만큼 처리 가능
                - 하나의 쓰레드가 지연 되어도 나머지 쓰레드가 동작
            - 단점
                - 쓰레드의 비싼 생성 비용
                - 컨텍스트 스위칭(쓰레드를 전환) 비용
                - 쓰레드 생성에 제한이 없으므로, CPU나 메모리의 임계점을 넘으면 서버가 죽을 수 있음
        - 따라서, 대부분 쓰레드 풀을 사용
            - 요청마다 쓰레드 생성 방식의 단점 보완
            - 쓰레드 풀에 미리 사용할 쓰레드들을 만들어 둠
            - 요청이 오면 쓰레드 풀의 쓰레드를 사용하고 반환 + 모든 쓰레드가 사용 중이면 대기 or 거절
            - 톰캣은 default 200개
            - 장점
                - 쓰레드 미리 생성 : 쓰레드 생성, 종료 비용 절약 -> 응답시간 빠름
                - 생성 가능한 쓰레드 최대치가 존재 : 많은 요청에도 기존 요청은 안전하게 처리 가능
            - 실무 팁
                - WAS의 주요 튜닝 포인트 == 최대 쓰레드 수
                    - 너무 낮으면, CPU 활용률은 낮고 많은 요청 처리 어려움
                    - 너무 높으면, 임계점 초과 시 서버 다운
                - 클라우드면, 일단 서버 늘리고 추후 튜닝, 클라우드 아니면 열심히 튜닝
                - 적정 숫자 찾기
                    - 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 상이
                    - 성능테스트!
                        - 실제 서비스와 유사하게 테스트 시도
                        - 툴 : 아파치, 제이미터, nGrinder
    - 멀티 쓰레드 부분은 WAS가 처리 -> 개발자는 멀티 쓰레드 관련 코드 신경 안써도 됨 -> 개발 생산성 높아짐
        - 다만, 멀티 쓰레드 환경이므로 싱글톤 객체를 주의해서 사용!



            

